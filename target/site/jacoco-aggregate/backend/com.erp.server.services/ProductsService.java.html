<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ProductsService.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">erp-backend</a> &gt; <a href="../index.html" class="el_bundle">backend</a> &gt; <a href="index.source.html" class="el_package">com.erp.server.services</a> &gt; <span class="el_source">ProductsService.java</span></div><h1>ProductsService.java</h1><pre class="source lang-java linenums">package com.erp.server.services;

import infra.global.entities.AttachmentEntity;
import infra.global.entities.ProductEntity;
import com.erp.server.exceptions.ProductDescriptionRequiredException;
import com.erp.server.exceptions.ProductImageRequiredException;
import com.erp.server.exceptions.ProductNameRequiredException;
import com.erp.server.exceptions.ProductNotFoundException;
import infra.global.repositories.AttachmentsRepository;
import infra.global.repositories.ProductsRepository;
import lombok.AllArgsConstructor;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;

import java.util.Base64;
import java.util.List;
import java.util.concurrent.TimeUnit;

@Service
@AllArgsConstructor
public class ProductsService {
    private final ProductsRepository productsRepository;
    private final AttachmentsRepository attachmentsRepository;
    private final RedisTemplate&lt;String, byte[]&gt; redisImageTemplate;
    private final RedisTemplate&lt;String, String&gt; redisImageTypeTemplate;

    private final long IMAGE_CACHE_EXPIRATION = 60 * 60;

    public List&lt;ProductEntity&gt; getAll() {
<span class="fc" id="L30">        return productsRepository.findAllByDeletedFalse();</span>
    }

    public ProductEntity getById(Long id) throws ProductNotFoundException {
<span class="fc" id="L34">        return productsRepository.findByIdAndDeletedFalse(id)</span>
<span class="fc" id="L35">                .orElseThrow(ProductNotFoundException::new);</span>
    }

    public void create(String name, String description, byte[] image, String imageType) throws ProductNameRequiredException, ProductDescriptionRequiredException, ProductImageRequiredException {
<span class="pc bpc" id="L39" title="1 of 4 branches missed.">        if (name == null || name.isEmpty()) throwProductNameRequiredException();</span>
<span class="pc bpc" id="L40" title="1 of 4 branches missed.">        if (description == null || description.isEmpty()) throwProductDescriptionRequiredException();</span>
<span class="pc bpc" id="L41" title="1 of 4 branches missed.">        if (image == null || imageType == null) throwProductImageRequiredException();</span>

<span class="fc" id="L43">        AttachmentEntity attachmentEntity = new AttachmentEntity(Base64.getEncoder().encodeToString(image), imageType);</span>
<span class="fc" id="L44">        attachmentsRepository.save(attachmentEntity);</span>
<span class="fc" id="L45">        ProductEntity productEntity = new ProductEntity(name, description, attachmentEntity);</span>
<span class="fc" id="L46">        productsRepository.save(productEntity);</span>
<span class="fc" id="L47">    }</span>

    private void throwProductImageRequiredException() throws ProductImageRequiredException {
<span class="fc" id="L50">        throw new ProductImageRequiredException();</span>
    }

    private void throwProductDescriptionRequiredException() throws ProductDescriptionRequiredException {
<span class="fc" id="L54">        throw new ProductDescriptionRequiredException();</span>
    }

    private void throwProductNameRequiredException() throws ProductNameRequiredException {
<span class="fc" id="L58">        throw new ProductNameRequiredException();</span>
    }

    public void update(Long id, String name, String description, byte[] image, String imageContentType) throws ProductNotFoundException, ProductNameRequiredException, ProductDescriptionRequiredException {
<span class="pc bpc" id="L62" title="1 of 4 branches missed.">        if (name == null || name.isEmpty()) throwProductNameRequiredException();</span>
<span class="pc bpc" id="L63" title="1 of 4 branches missed.">        if (description == null || description.isEmpty()) throwProductDescriptionRequiredException();</span>

<span class="fc" id="L65">        AttachmentEntity attachmentEntity = null;</span>
<span class="fc" id="L66">        AttachmentEntity oldAttachmentEntity = null;</span>
<span class="pc bpc" id="L67" title="1 of 4 branches missed.">        if (image != null &amp;&amp; imageContentType != null) {</span>
<span class="fc" id="L68">            attachmentEntity = new AttachmentEntity(Base64.getEncoder().encodeToString(image), imageContentType);</span>
<span class="fc" id="L69">            attachmentsRepository.save(attachmentEntity);</span>
        }

<span class="fc" id="L72">        ProductEntity productEntity = getById(id);</span>
<span class="fc" id="L73">        productEntity.setName(name);</span>
<span class="fc" id="L74">        productEntity.setDescription(description);</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (attachmentEntity != null) {</span>
<span class="fc" id="L76">            oldAttachmentEntity = productEntity.getAttachmentEntity();</span>
<span class="fc" id="L77">            oldAttachmentEntity.delete();</span>
<span class="fc" id="L78">            productEntity.setAttachmentEntity(attachmentEntity);</span>
<span class="fc" id="L79">            clearCachedImage(id);</span>
        }
<span class="fc" id="L81">        productsRepository.save(productEntity);</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">        if (oldAttachmentEntity != null) {</span>
<span class="fc" id="L83">            attachmentsRepository.save(oldAttachmentEntity);</span>
        }
<span class="fc" id="L85">    }</span>

    private void clearCachedImage(Long productId) {
<span class="fc" id="L88">        String imageKey = getImageKey(productId);</span>
<span class="fc" id="L89">        String imageTypeKey = getImageTypeKey(productId);</span>
<span class="fc" id="L90">        redisImageTemplate.delete(imageKey);</span>
<span class="fc" id="L91">        redisImageTypeTemplate.delete(imageTypeKey);</span>
<span class="fc" id="L92">    }</span>

    public void deleteById(Long id) throws ProductNotFoundException {
<span class="fc" id="L95">        ProductEntity productEntity = getById(id);</span>
<span class="fc" id="L96">        productEntity.delete();</span>
<span class="fc" id="L97">        productsRepository.save(productEntity);</span>
<span class="fc" id="L98">    }</span>

    public byte[] getProductImage(Long productId) throws ProductNotFoundException {
<span class="fc" id="L101">        byte[] cachedImage = getCachedImage(productId);</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">        if (cachedImage != null) return cachedImage;</span>

<span class="fc" id="L104">        ProductEntity productEntity = cacheProductData(productId);</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (productEntity == null) return null;</span>

<span class="fc" id="L107">        return getDecodedImage(productEntity);</span>
    }

    private ProductEntity cacheProductData(Long productId) throws ProductNotFoundException {
<span class="fc" id="L111">        ProductEntity productEntity = getById(productId);</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">        if (!productEntity.hasAttachment()) return null;</span>

<span class="fc" id="L114">        byte[] imageBytes = getDecodedImage(productEntity);</span>
<span class="fc" id="L115">        cacheImage(productId, imageBytes, productEntity.getImageType());</span>
<span class="fc" id="L116">        return productEntity;</span>
    }

    private static byte[] getDecodedImage(ProductEntity productEntity) {
<span class="fc" id="L120">        return Base64.getDecoder().decode(productEntity.getImageBase64());</span>
    }

    private void cacheImage(Long productId, byte[] imageBytes, String imageType) {
<span class="fc" id="L124">        String imageKey = getImageKey(productId);</span>
<span class="fc" id="L125">        String imageTypeKey = getImageTypeKey(productId);</span>
<span class="fc" id="L126">        redisImageTemplate.opsForValue().set(imageKey, imageBytes, IMAGE_CACHE_EXPIRATION, TimeUnit.SECONDS);</span>
<span class="fc" id="L127">        redisImageTypeTemplate.opsForValue().set(imageTypeKey, imageType, IMAGE_CACHE_EXPIRATION, TimeUnit.SECONDS);</span>
<span class="fc" id="L128">    }</span>

    private byte[] getCachedImage(Long productId) {
<span class="fc" id="L131">        String key = getImageKey(productId);</span>
<span class="fc" id="L132">        return getBytes(key);</span>
    }

    private byte[] getBytes(String key) {
<span class="fc" id="L136">        return redisImageTemplate.opsForValue().get(key);</span>
    }

    private String getImageKey(Long productId) {
<span class="fc" id="L140">        return &quot;product:image:&quot; + productId;</span>
    }

    private String getImageTypeKey(Long productId) {
<span class="fc" id="L144">        return &quot;product:image:type:&quot; + productId;</span>
    }

    public String getProductImageType(Long productId) throws ProductNotFoundException {
<span class="fc" id="L148">        String cachedImageType = getCachedImageType(productId);</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">        if (cachedImageType != null) return cachedImageType;</span>

<span class="fc" id="L151">        ProductEntity productEntity = cacheProductData(productId);</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">        if (productEntity == null) return null;</span>

<span class="fc" id="L154">        return productEntity.getImageType();</span>
    }

    private String getCachedImageType(Long productId) {
<span class="fc" id="L158">        return redisImageTypeTemplate.opsForValue().get(getImageTypeKey(productId));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>